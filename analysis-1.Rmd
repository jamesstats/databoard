---
date: "2025-12-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Westminster Voting Intention 

```{r,westminster,echo=FALSE,warning=FALSE,message=FALSE, fig.align='center',fig.width=12,fig.height=6}   
library(ggplot2)
library(dplyr)
library(readxl)
library(ggrepel)
library(mgcv)

# Load Data
data <- read_xlsx("data/UKPolling.xlsx")
data$Date <- as.Date(data$Date)
df <- data %>% filter(!is.na(Party), !is.na(Share))

# Calculate GAM Trend (Using k=20 as per your slider default)
df_trend <- df %>%
  arrange(Party, Date) %>%
  group_by(Party) %>%
  group_modify(~{
    x_num <- as.numeric(.x$Date)
    gam_fit <- gam(Share ~ s(x_num, k = 20), data = .x, method = "REML")
    preds <- predict(gam_fit, se.fit = TRUE)
    .x$RollingShare <- preds$fit
    .x$UpperCI <- preds$fit + 1.96 * preds$se.fit
    .x$LowerCI <- preds$fit - 1.96 * preds$se.fit
    .x
  })

latest_points <- df_trend %>% group_by(Party) %>% filter(Date == max(Date)) %>% slice(1)

# Plot
ggplot(df_trend, aes(x = Date, y = RollingShare, color = Party)) +
  geom_ribbon(aes(ymin = LowerCI, ymax = UpperCI, fill = Party), alpha = 0.15, color = NA) +
  geom_line(linewidth = 1.2) +
  geom_text_repel(data = latest_points, aes(label = paste0(round(RollingShare, 1), "%")), 
                  nudge_x = 10, size = 3, fontface = "bold") +
  
  theme_classic() +
  labs(title = ".",y=".",x=".") +
  scale_color_manual(values = c("Lab"="#E4003B","Con"="#0087DC","Ref"="cyan","Lib"="#FAA61A","Grn"="#6AB023","SNP"="yellow")) +
  scale_fill_manual(values = c("Lab"="#E4003B","Con"="#0087DC","Ref"="cyan","Lib"="#FAA61A","Grn"="#6AB023","SNP"="yellow"))

``` 